# 任务计划：移植 Ant Design Form 与 Upload 组件

## 目标与范围
- 在当前 `adui-dioxus` 基础上新增 `Form` 与 `Upload` 组件，实现与 `tmp/antd-6.0.0` 版本相当的 API 和交互。
- 整合现有主题/布局/按钮体系，保证 Form 和 Upload 与 Button、Input、Grid 等组件协同工作。
- 补充文档、示例与计划任务，确保后续能够持续跟踪。

## 总体策略
- 优先对 Form 和 Upload 的核心能力进行差异分析，确定最小可交付版本（MVP），并规划后续增强点。
- 按子模块拆分任务（类型定义、上下文、核心逻辑、样式、示例、文档），每个模块在 TODO 中标记状态。
- 对 Dioxus 特性（Signal、EventHandler、RSX）与 AntD React 实现进行映射，避免直接复制 React 逻辑。

## Form 组件拆解
1. **Props 与类型定义**
   - FormProps：layout(horizontal/vertical/inline)、colon、label_align、label_col/wrapper_col、size、disabled、initial_values、scroll_to_error 等。
   - FormItemProps：name(s)/label/required/rules/help/validate_status/extra/has_feedback/value_prop_name/get_value_from_event/no_style。
   - `FormInstance` 替代：定义 `FormHandle` 或 hook（类似 `useForm`）以暴露 `set_fields_value`, `validate_fields`, `reset_fields` 等。
2. **上下文与状态管理**
   - FormContext：提供 `register_field`, `unregister_field`, `notify_change`, `get_field_value` 等方法。
   - ItemContext：传递 label/required/feedback 状态给子组件。
   - Dioxus 实现：使用 Signal/SharedState 管理字段值和错误；考虑 `Rc<RefCell<>>` 或 `Signal<HashMap>`。
3. **验证与规则系统**
   - 支持同步规则（required, min/max, pattern, enum）与自定义函数（返回 Result/Option）。初期可只支持同步；异步校验列入后续。
   - 提供 `validate_trigger`（onChange/onBlur）与 `trigger` 兼容逻辑。
4. **布局与样式**
   - 参照 AntD Form 样式：label/wrapper 栅格、colon、help/extra 信息、feedback 图标。
   - 复用 Grid/Flex 工具生成 label/wrapper col 类名。
5. **交互**
   - `Form` on_finish/on_finish_failed，`Form.Item` 收集校验状态，向 FormContext 报告。
   - 支持 controlled/uncontrolled 模式（`Form` 传入 `initial_values` + `FormHandle`）。
6. **示例与文档**
   - 新增 `examples/form_demo.rs`：展示基本表单、校验、布局切换。
   - 文档：`docs/form.md` 描述 API 与差异。

### Form API 设计（MVP）
- `FormProps`
  - `layout: FormLayout`（Horizontal/Vertical/Inline，默认 Horizontal）
  - `size: ControlSize`（Small/Middle/Large），`colon: bool`，`required_mark: RequiredMark`
  - `label_align: LabelAlign`（Left/Right），`label_col` / `wrapper_col`: `Option<ColSpec>`（span/offset/flex）
  - `disabled: bool`，`preserve: bool`，`initial_values: Option<FormValues>`
  - `form: Option<FormHandle>`（受控模式），`scroll_to_error: bool`
  - 回调：`on_finish(FormValues)`, `on_finish_failed(FormErrorInfo)`, `on_values_change(FormValues, ChangedFields)`, `on_fields_change(Vec<FormFieldMeta>)`
- `FormHandle`（`use_form` 输出）
  - 方法：`set_fields_value`, `set_field_value`, `get_fields_value`, `get_field_value`, `reset_fields`, `clear_validate`, `validate_fields`, `submit`, `is_fields_touched`, `get_field_error`, `set_field_error`
  - 内部实现：`Rc<FormStore>` + `Signal<HashMap<NamePath, FieldState>>`
- `FormItemProps`
  - `name: Option<FormNamePath>`（Vec<NameSegment>），`label: Option<Element>`、`tooltip: Option<String>`
  - `rules: Vec<FormRule>`（required/pattern/validator/message），`dependencies: Vec<FormNamePath>`，`should_update: Option<FormShouldUpdate>`
  - `value_prop_name: String`（默认 `value`），`get_value_from_event: Option<FormValueExtractor>`，`normalize: Option<Normalizer>`
  - UI：`help`, `extra`, `validate_status: Option<ValidateStatus>`, `has_feedback: bool`, `no_style: bool`, `hidden: bool`
- 其他
  - `FormList`：`name`, `children(index, mutOps, meta)`，`initial_value`，`rules`
  - `FormRule`：`required`, `min`, `max`, `len`, `pattern`, `enum_values`, `validator`
  - `ValidateStatus`: `Success | Warning | Error | Validating`
  - `FormLayout`, `ControlSize`, `RequiredMark`, `LabelAlign`, `ColSpec` 等辅助类型

## Upload 组件拆解
1. **Props 与类型**
   - UploadProps：action、name、method、headers、with_credentials、multiple、accept、before_upload、on_change、on_preview、show_upload_list、list_type(text/picture/picture-card)、max_count、file_list（受控模式）。
   - UploadFile 类型：uid/name/status(percent)/response/error/url/thumb_url/raw 等。
   - Dragger 变体：支持拖拽上传事件。
2. **核心逻辑**
   - beforeUpload：可返回 bool 或 Future（考虑同步 MVP，异步下一阶段）。
   - 请求发送：初期支持浏览器 fetch/XMLHttpRequest 调用；Web 端可用 `gloo-net`; 需要考虑 wasm 目标。
   - 进度更新：XHR onprogress -> Signal 更新。
   - 列表管理：基于 `Signal<Vec<UploadFile>>`，同步 props `file_list` / `default_file_list`。
3. **UI 与样式**
   - 基础按钮/区域 + 上传列表（展示 Icon、文件名、进度条、操作按钮）。
   - list_type=picture/picture-card 对应样式；Dragger 的 hover/dragover 状态。
   - 复用 Theme tokens 控制颜色、radius。
4. **交互**
   - onChange 在文件状态更新时触发（uploading/done/error/removed）。
   - beforeUpload 可阻止文件加入队列（返回 false）；`on_remove` Hook。
   - 支持点击/拖拽触发 `<input type="file">`。
5. **示例与文档**
   - `examples/upload_demo.rs`：展示基本上传、图片墙、拖拽。
   - `docs/upload.md`：API、受控/非受控示例、注意事项。

### Upload API 设计（MVP）
- `UploadProps`
  - 网络：`action: Option<String>`, `method: HttpMethod`, `headers: Option<Vec<(String, String)>>`, `data: Option<Vec<(String, String)>>`, `with_credentials: bool`
  - 选择：`name: String`, `multiple: bool`, `accept: Option<String>`, `directory: bool`, `open_file_dialog_on_click: bool`, `disabled: bool`
  - 行为：`before_upload: Option<UploadBeforeFn>`, `custom_request: Option<UploadRequestFn>`, `on_change`, `on_remove`, `on_preview`, `on_download`, `on_drop`, `max_count: Option<usize>`
  - 列表：`file_list: Option<Vec<UploadFile>>`（受控）、`default_file_list`, `list_type: UploadListType` (`Text | Picture | PictureCard`), `show_upload_list: UploadListConfig`
  - 外观：`class`, `style`, `description: Option<Element>`, `icon: Option<Element>`, `dragger: bool`
- `UploadFile`
  - `uid: String`, `name: String`, `status: UploadStatus` (`Uploading | Done | Error | Removed`), `percent: Option<f32>`, `size: Option<u64>`
  - `origin_file: Option<FileHandle>`, `response: Option<Value>`, `error: Option<String>`, `url: Option<String>`, `thumb_url: Option<String>`
- `UploadChangeInfo`
  - `file: UploadFile`, `file_list: Vec<UploadFile>`, `event: Option<Progress>`，提供 `type` 字段表示 add/remove/update
- `UploadRequestOptions`
  - `file: FileHandle`, `action`, `filename`, `headers`, `data`, `method`, `with_credentials`
  - 回调：`on_progress(Progress)`, `on_success(Response)`, `on_error(String)`, `abort()`
- `UploadListConfig`
  - `show_remove_icon`, `show_preview_icon`, `show_download_icon`, `custom_icon?: UploadListIconSet`
- `UploadDraggerProps`
  - `height: Option<f32>`, `class`, `style`, `children`；内部复用 Upload 并附加 drag 状态 Signal

## TODO 列表
- [ ] **Form 组件**
  - [x] 阅读 `tmp/antd-6.0.0/components/form`，整理差异与需求（生成 `docs/diff/form.md`）。
  - [x] 设计 `FormProps/FormItemProps`、`FormHandle` API。
  - [x] 实现 `FormContext`，支持字段注册、值存储、校验触发（当前 registry + required rule）。
  - [x] 实现 `Form` 渲染（layout/colon 控制 + Signal store 注入）。
  - [x] 实现 `FormItem`（label/help/feedback/error 输出；暂未实现 no_style/should_update）。
  - [x] 校验规则引擎（required/pattern/min/max/custom —— 当前仅 required）。
  - [x] 提供 `use_form` Hook/Handle（已提供 `use_form()` 返回 `FormHandle`，示例仍待补充）。
  - [x] 样式：label 行、colon、error/help/feedback 图标。
  - [x] Demo `examples/form_demo.rs`。
  - [x] 文档 `docs/form.md`。

- [ ] **Upload 组件**
  - [x] 阅读 `tmp/antd-6.0.0/components/upload`，整理差异与需求（`docs/diff/upload.md`）。
  - [x] 设计 `UploadProps`、`UploadFile`、`UploadListType`、`UploadRequest` API。
  - [x] 实现文件选择逻辑（input 选择 + beforeUpload 过滤；拖拽待后续）。
  - [x] 上传流程（XHR/fetch 请求、progress 更新、abort）。
  - [x] 管理文件列表（受控/非受控 `Signal`，触发 `on_change/on_remove`）。
  - [x] UploadList UI（text/picture/picture-card）；
  - [x] Dragger 容器。
  - [x] Demo `examples/upload_demo.rs`（基本、图片墙、拖拽）。
  - [x] 文档 `docs/upload.md`。

- [ ] **共通事项**
  - [x] 将新组件纳入 `src/lib.rs` 导出，并在 README/plan 更新。
  - [x] 运行 `cargo fmt`, `cargo clippy --all-targets --all-features`, `cargo test` 验证。

> 执行过程中如需拆分子任务，请在本文件追加子 TODO，以便跟踪进度。
