# 0014 移植推荐组件落地计划

目标：基于 antd 6.0.0，分阶段移植一组数值/选择类控件（input-number、slider、rate、segmented、color-picker），形成可复用的基础设施并完成验证。

## 里程碑
- M1：完成需求澄清与 API 草案，确定主题 token 映射与依赖关系。
- M2：完成 input-number 与 slider 的核心实现与示例，用于支撑后续组件。
- M3：完成 rate、segmented 复用基础设施的实现与示例。
- M4：完成 color-picker（含色板、滑条、输入联动）并通过联动测试。
- M5：补充文档、示例与回归测试（含无障碍与键盘交互），准备合入。

## Todo List（状态可勾选）
- [x] 需求梳理
  - [x] 研读 antd 原版 API 与行为（禁用态、键盘交互、边界值）。
  - [x] 输出组件 API 草稿（props、事件、受控/非受控策略）。
  - [x] 梳理主题变量映射（尺寸、色板、边框、阴影）。
- [ ] 基础设施
  - [x] 提炼公共数值控制逻辑（步进、精度、格式化/解析）。
  - [x] 提炼滑条轨道/手柄渲染与无障碍封装（ARIA、键盘）。
  - [x] 补充公共交互 Hook（聚焦管理、拖拽/触摸事件抽象）。
- [ ] 组件实现
  - [x] input-number：步进、格式化与边界校验（基础版，后续可加长按加速）。
  - [x] slider：单滑块/范围模式、刻度、禁用与键盘操作。
  - [x] rate：半星、清除、键盘操作，复用基础滑条逻辑。
  - [x] segmented：按钮组样式与键盘导航，支持图标/禁用态。
  - [x] color-picker：色相/饱和度/明度/透明度联动，取色预览与输入框。
- [ ] 示例与文档
  - [x] 为每个组件新增 examples/* 子目录，覆盖基础、受控/非受控、禁用、尺寸切换。
  - [ ] docs 中补充 API 说明、交互细节与可访问性要点。
- [ ] 测试与质量
  - [ ] 单元测试覆盖边界值、受控同步、键盘/鼠标事件。
  - [ ] 视觉/快照测试：核心状态（默认、hover、active、禁用）。
  - [ ] 自查清单：cargo fmt / clippy / test 通过，新增公开 API 带文档。

## 进展记录

- 需求梳理（完成）：
  - 组件 API 草稿：
    - InputNumber：value/default_value、step、min/max、precision、formatter/parser、controls（可自定义图标）、size、variant、status、prefix/suffix、disabled，事件 on_change/on_change_complete/on_focus/on_blur/on_press_enter，支持受控/非受控。
    - Slider：range 单/双滑块，step/null，marks、dots、included、reverse、vertical/orientation、tooltip 配置（formatter/open/placement）、keyboard、disabled，事件 on_change/on_change_complete/on_focus/on_blur。
    - Rate：count（默认 5）、allow_half、allow_clear、character（图标/节点）、tooltips、size、disabled/auto_focus，事件 on_change/on_hover_change/on_focus/on_blur，受控/非受控。
    - Segmented：options(label/value/icon/tooltip/disabled)、value/default_value、block、size、shape(default/round)、vertical/orientation、disabled，事件 on_change，支持自定义 classNames/styles。
    - ColorPicker：mode(single/gradient)、value/default_value（单色或线性渐变）、format/default_format(hex/rgb/hsb)、presets、allow_clear、disabled/disabled_alpha、open/trigger/placement、show_text、arrow、panel_render、on_change/on_change_complete/on_clear/on_open_change、on_format_change，复用 Popover 容器配置。
  - 主题变量映射：
    - InputNumber：--adui-control-height(s/m/l)、--adui-color-bg-container、--adui-color-border、--adui-color-primary、--adui-color-text、--adui-shadow、--adui-radius；禁用用 --adui-color-bg-base/opacity。
    - Slider：轨道/手柄用 --adui-color-primary、--adui-color-bg-base、--adui-color-fill-secondary；手柄聚焦/hover 用 --adui-shadow、--adui-color-primary-active；刻度文字用 --adui-color-text-secondary。
    - Rate：星形填充/hover 用 --adui-color-warning/hover/active；未选用 --adui-color-fill-secondary；尺寸挂钩 --adui-control-height 与 icon 尺寸表。
    - Segmented：容器/项使用 --adui-color-bg-container、--adui-color-border、--adui-color-text、--adui-color-text-secondary、--adui-color-primary；尺寸与圆角用 --adui-control-height-*、--adui-radius/--adui-radius-lg。
    - ColorPicker：面板/触发器用 --adui-color-bg-container、--adui-color-border、--adui-color-primary、--adui-shadow、--adui-radius-sm/--adui-radius；滑条复用 Slider token，数值框复用 InputNumber token。
- 基础设施进展：
  - 新增 `src/components/number_utils.rs`，集中封装 clamp/step/precision/parse 逻辑，方便 InputNumber/Slider/Rate/ColorPicker 复用。
  - 新增 `src/components/slider_base.rs`，统一 value↔ratio 转换、步进/精度、方向反转与键盘行为映射；附基础单元测试。
  - 新增 `src/components/interaction.rs`，抽象 Pointer 捕获/释放与拖拽状态，供滑条/取色等组件共享。
- 组件实现进展：
  - 新增 `src/components/input_number.rs`，支持受控/非受控、表单集成、步进和边界/精度约束、键盘增减与自定义前后缀；样式落地在 `theme.rs`，后续可补长按加速与更丰富的图标样式。
  - 新增 `src/components/slider.rs`，支持单滑块/范围、受控/表单集成、步进与精度、键盘/拖拽/轨道点击，支持 marks+dots；样式在 `theme.rs`，包含横向/纵向与禁用态。
  - 新增 `src/components/rate.rs`，支持半星、清除、键盘/指针交互与受控/表单集成，可自定义字符与 tooltip；样式在 `theme.rs`。
  - 新增 `src/components/segmented.rs`，支持受控/表单集成、block/round/禁用、键盘左右导航，支持图标与 tooltip，样式在 `theme.rs`。
  - 新增 `src/components/color_picker.rs`，提供 HSVA 单色取色（饱和度/明度面板、色相与透明度滑条、Hex 输入与清空），支持受控/表单集成与回调；样式在 `theme.rs`。
- 示例与文档进展：\n  - 在 `examples/` 下新增 input_number/slider/rate/segmented/color_picker 示例，覆盖基础、受控/禁用、竖向/范围等场景。\n  - 在 `docs/` 下新增 input_number.md、slider.md、rate.md、segmented.md、color_picker.md，补充 API 要点与交互说明。\n*** End Patch

## 风险与缓解
- 键盘与无障碍行为未对齐：优先实现 aria-* 属性与键盘映射，参考 antd 行为。
- 数值精度与解析差异：集中封装格式化/解析逻辑，单元测试覆盖小数与边界。
- 拖拽/触摸兼容性：提前抽象事件 Hook，桌面与移动统一入口。
- 主题一致性：先对齐 token 名称，避免后期大规模样式调整。
