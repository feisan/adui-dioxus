# 任务计划：App + ConfigProvider + 全局反馈组件（Phase 3）

## 一、背景与本轮目标

前几轮（`plan/0001`–`0005`）已经完成：

- Button / FloatButton / Grid / Layout / Typography 等基础组件的对齐与重构；
- Form 及其高级能力（FormList、字段联动、值映射等）的实现；
- Input / Checkbox / Radio / Switch 等表单控件与 Form 的受控模式统一；
- 文档、示例与实现保持同步更新。

Ant Design 6.x 中，与这些基础能力高度协同的一组组件是：

- `App`
- `ConfigProvider`
- 全局反馈组件：`message`、`notification`
- 浮层容器组件：`Modal`、`Drawer`

它们共同构成了「全局配置 + 全局反馈 + 页面级浮层」能力，是复杂业务中与表单、布局配合最频繁的一组组件。本轮（Phase 3）目标是：

- 在 Dioxus/Rust 语境下，设计并实现一套与 AntD 行为尽量对齐的 `App` / `ConfigProvider`；
- 在此基础上实现 MVP 版本的 `Message` / `Notification` / `Modal` / `Drawer`；
- 建立统一的全局 overlay 管理与配置上下文，并通过示例和文档沉淀设计要点。

> 说明：本轮以 MVP 为主，不追求一次性覆盖 AntD 所有细节（如所有静态方法变体、复杂的 motion / CSSMotion 行为等），但要确保 API 方向正确、行为可预期，便于后续迭代。

---

## 二、设计原则

1. **API 尽量向 AntD 6.x 靠拢**
   - 命名与主要 props 语义参考 `tmp/antd-6.0.0/es` 下的原版实现；
   - 对于不适合直接搬运的部分，以 Rust/Dioxus 习惯进行调整，并在文档中说明差异。

2. **上下文与全局状态严格受控**
   - 通过 `App` / `ConfigProvider` / 专用 context 管理全局配置与 overlay 状态；
   - 避免随处可见的全局静态变量，方便测试与多实例（多 App）场景。

3. **Overlay 能力统一抽象**
   - `Message` / `Notification` / `Modal` / `Drawer` 共享一套基础能力：
     - Portal 挂载点；
     - z-index 管理；
     - mask / 滚动锁定策略；
     - 动画时机与关闭时机；
   - 在此基础上保留各组件特有的交互差异。

4. **可渐进增强**
   - 先实现最常用场景（如 `message.success`、`Modal` 受控使用和基础 confirm）；
   - 将未覆盖能力显式写入文档中的「暂不支持／规划中」，避免使用方误解。

---

## 三、任务拆解与 TODO

### A. 能力范围与 API 草案

- [x] A1：调研 `tmp/antd-6.0.0/es` 中 `app`、`config-provider`、`message`、`notification`、`modal`、`drawer` 目录及 `_util` 相关实现，总结：
  - 关键 props / 静态方法 / hooks API（如 `App.useApp`、`message.open`、`Modal.confirm` 等）；
  - AntD 6 与 5 在这些组件上的差异；
  - 可以直接复用的交互模式与需要调整的地方。
- [x] A2：结合现有 `ThemeProvider`、Form、Layout 等能力，确定本轮的 **MVP 范围**，明确：
  - 每个组件要支持的 props 与行为；
  - 本轮暂不支持但保留扩展空间的能力（例如：多容器挂载、复杂 motion、自定义图标集等）。
- [x] A3：在 `docs/` 下新增或扩展相关文档（例如 `docs/app_config.md` 或在现有文档中新增章节），记录：
  - 各组件的角色划分（App / ConfigProvider / Message / Notification / Modal / Drawer）；
  - MVP 能力范围与未来扩展方向。

### B. 基础设施：Portal / Overlay 管理与上下文

> 目标：为所有全局反馈与浮层组件提供统一的技术基础，避免重复轮子。

- [x] B1：梳理现有代码中是否已有 Portal / overlay 实现（如利用 Dioxus 自身 portal 能力），评估是否需要：
  - 新增 `overlay` 辅助模块；或
  - 在现有 `control.rs` / 其他基础模块中扩展通用能力。
- [x] B2：设计并在文档中描述一个简单的 `OverlayManager` 抽象，包括：
  - 全局挂载点（根 DOM 节点）与多层 overlay 堆叠顺序（z-index）；
  - mask 行为（是否可点击关闭、滚动锁定策略）；
  - overlay item 的生命周期管理（打开、关闭、销毁）。
- [x] B3：在实现层面（`src/components/...`）落地 `OverlayManager` 基础设施：
  - 约定内部数据结构（如一个 `Vec<OverlayEntry>` 或者基于 `HashMap` 的 keyed 列表）；
  - 提供最小操作集：`open` / `update` / `close` / `close_all`；
  - 提供与 Dioxus 的集成方式（如 context + `use_signal` / `use_ref` 等）。
- [x] B4：为 overlay 基础设施增加一个极简验证 demo（可以是内部测试用 demo，不暴露给外部文档），确认 portal 挂载和 z-index 堆叠行为正确。

### C. ConfigProvider：全局配置上下文

- [x] C1：对照 AntD `ConfigProvider`，设计 Rust 版本的 props 结构，初步包含：
  - 全局 `size`（small / middle / large）；
  - 全局 `disabled`（默认禁用交互）；
  - 全局 `prefix_cls` 或样式前缀策略（可简化）；
  - 全局 `locale`（仅预留结构，实际文案可以先不全）；
  - 与现有 ThemeProvider 的集成方式（如主题 token、色板）。
- [x] C2：在 `src/components` 下新增 `config_provider.rs` 或类似模块，定义：
  - `ConfigProvider` 组件；
  - `ConfigContext` 类型（包含上面提到的配置项）；
  - `use_config` 辅助方法，用于各组件读取配置。
- [x] C3：在不破坏现有 API 的前提下，选取若干代表性组件（如 Button、Input、Modal）接入 `ConfigContext`：
  - 优先接入 `size`、`disabled`、`prefix` 等对 UI 与交互影响明显的配置；
  - 保证本地 props 优先级高于全局配置，行为与 AntD 一致。
- [x] C4：新增 `examples/config_provider_demo.rs`，展示：
  - 全局 size/disabled 对 Button/Input/Modal 的影响；
  - 嵌套 ConfigProvider 时的覆盖行为；
  - 与 ThemeProvider 的配合（如一处配置，处处生效）。
- [x] C5：在文档中新增「ConfigProvider 与全局配置」小节，说明：
  - 当前支持的配置项；
  - 优先级规则；
  - 与 AntD 的主要差异与限制。

### D. App：全局入口与 use_* API

- [x] D1：对照 AntD `App` 组件与 `App.useApp()`，设计 Dioxus 中的等价模式：
  - 顶层 `App` 组件包裹应用，内部挂载 overlay root 与 `ConfigProvider`；
  - 暴露 `use_message` / `use_notification` / `use_modal` 等 hooks 风格 API。
- [x] D2：在 `src/components` 中新增 `app.rs` 模块（或与 ConfigProvider 共用一个更高层模块），定义：
  - `App` 组件及其 props；
  - `AppContext` 结构，内部包含各全局 API handle（message/notification/modal 等）。
- [x] D3：实现 `use_message` / `use_notification` / `use_modal` 等 hooks：
  - 从 `AppContext` 中取得对应 API；
  - 保证多 App 实例时，各自的全局反馈相互隔离。
- [x] D4：新增 `examples/app_demo.rs`，展示：
  - 使用 `App` 包裹应用；
  - 在子组件中使用 `use_message` 触发全局消息；
  - 与 ConfigProvider 的组合（如统一 size 与主题）。
- [x] D5：在文档中增加「App 与 use_* API」小节，解释：
  - 为什么需要 App 这一层；
  - 如何在 Dioxus 里正确挂载与使用；
  - 与 AntD `App.useApp` 的关系与差异。

### E. Message & Notification：全局反馈

- [x] E1：对照 AntD 源码与文档，提炼 `Message` 与 `Notification` 的核心能力：
  - 公共点：类型（success/info/warning/error/loading）、时长、可关闭、队列管理、全局配置；
  - 差异点：位置（Notification 多为右上角）、可包含更复杂的内容（标题、描述、icon 等）。
- [x] E2：设计内部数据模型与 API 类型：
  - `MessageApi`: `open`, `success`, `error`, `info`, `warning`, `loading`, `destroy`；
  - `NotificationApi`: `open`, `success`, `error`, `info`, `warning`, `close`, `destroy`；
  - item 结构（id/key、content、type、duration、onClose 等）。
- [x] E3：基于 `OverlayManager` 实现 `Message` 渲染与队列逻辑：
  - 定义对应的 Dioxus 组件，用于渲染消息列表；
  - 支持自动关闭（定时器）与手动关闭；
  - 处理堆叠顺序与入口动画（可以先用简化动画）。
- [x] E4：实现 `Notification`，可复用部分 `Message` 的数据模型与渲染逻辑：
  - 支持 placement（先支持 1–2 个典型位置，如 topRight / bottomRight）；
  - 支持标题 + 描述 + icon 的基本布局。
- [x] E5：新增示例：
  - `examples/message_demo.rs`：展示不同类型、时长、全局配置；
  - `examples/notification_demo.rs`：展示不同 placement 与复杂内容。 
- [x] E6：在文档中新增「全局反馈：Message / Notification」章节，记录：
  - API 设计与用法示例；
  - 当前与 AntD 的差异（如暂不支持 Promise 风格链式调用等）。

### F. Modal & Drawer：页面级浮层

- [x] F1：对照 AntD 的 `Modal` 与 `Drawer`，设计 Dioxus 版本的受控使用 API：
  - `open` / `on_ok` / `on_cancel` / `title` / `footer` / `closable` / `maskClosable` / `destroyOnClose` 等；
  - 优先实现受控组件形式，静态方法形式的 confirm/info 等放到后续步骤。
- [x] F2：基于 `OverlayManager` 实现 Modal：
  - 支持 mask 与 ESC 关闭；
  - 处理滚动锁定（防止背景页面滚动）；
  - 确定 z-index 与多 Modal 堆叠的行为（可简化为后打开的在最上层）。
- [x] F3：实现 Drawer，复用 Modal 的部分逻辑：
  - 主要差异在于入场方向（从侧边滑入）与尺寸控制；
  - 确保与 Modal 共存时的 z-index 与滚动策略一致。
- [ ] F4：在 `AppContext` 中为 Modal 提供简化版 API（类似 `Modal.confirm`）：（本轮暂不实现，保留为后续扩展）
  - 支持基本的确认对话框（标题 + 内容 + 确认/取消按钮）；
  - 将复杂用法（如多步对话、异步确认）暂列为未来扩展。
- [x] F5：新增示例：
  - `examples/modal_demo.rs`：展示基础 Modal、表单 Modal、确认对话框；
  - `examples/drawer_demo.rs`：展示基础 Drawer、带表单的 Drawer。 
- [x] F6：在文档中新增「浮层组件：Modal / Drawer」章节，记录：
  - 组件 props 与基础用法；
  - 与 Form 组合使用的推荐模式；
  - 当前与 AntD 的行为差异（如不支持某些 motion、暂不实现拖拽等）。

### G. 集成验证与收尾

- [x] G1：构建一个综合示例（如 `examples/overlay_integration_demo.rs`），验证：
  - ConfigProvider + App + Form + Modal/Drawer + Message/Notification 的组合使用；
  - 典型业务流程：点击按钮 -> 打开 Modal 表单 -> 提交 -> 成功/失败消息 -> 关闭 Modal。
- [x] G2：全量运行 `cargo fmt` / `cargo clippy --all-targets --all-features` / `cargo test`，并记录：
  - 新增或变化较大的模块的 clippy 建议；
  - 如有必要，为关键逻辑增加针对性的单元测试或集成测试。
- [x] G3：整理文档：
  - 在 `docs/README.md` 或导航文档中增加「App & ConfigProvider & 全局反馈」条目；
  - 在各组件文档中互相添加链接（例如 Form 文档中链接 Modal/Message 示例）。
- [x] G4：复盘本轮设计要点，补充到关键文档（如 `docs/design.md` 或 Form/Overlay 相关文档）中，尤其是：
  - 全局状态与上下文的设计取舍；
  - 与 AntD 行为不完全一致的地方及原因；
  - 后续可以继续迭代的方向（如 async confirm、validateTrigger 与 overlay 联动等）。
