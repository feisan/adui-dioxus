# 任务计划：选择器家族 Select / TreeSelect / Cascader / AutoComplete（Phase 4）

## 一、背景与本轮目标

前几轮（`plan/0001`–`0006`）已经完成：

- Button / FloatButton / Grid / Layout / Typography / Input / Checkbox / Radio / Switch 等基础组件；
- Form + Form 高级能力（FormList、字段联动、值映射）；
- App / ConfigProvider / OverlayManager；
- 全局反馈与浮层组件：Message / Notification / Modal / Drawer。

Ant Design 6.x 中，和这些基础能力结合最紧密、也是中大型业务表单中高频使用的一组组件是「选择器家族」：

- `Select`
- `TreeSelect`
- `Cascader`
- `AutoComplete`

它们共享大量底层能力（下拉浮层、选项建模、搜索过滤、键盘交互）并与 Form 深度集成，是「表单 + 数据选择」场景的主力。本轮（Phase 4）目标：

- 设计并实现一套统一的 option/value 模型和下拉选择基础设施；
- 在此基础上实现 MVP 版本的 Select / TreeSelect / Cascader / AutoComplete；
- 与 Form、App/ConfigProvider、OverlayManager 做好衔接，并通过示例与文档沉淀设计细节。

> 说明：本轮同样采用 MVP 策略，不一次性追求覆盖 AntD 全量特性，例如：虚拟滚动、大规模远程数据源、复杂搜索策略等，可在后续阶段迭代。

---

## 二、设计原则

1. **统一的选项与值模型**
   - 为 Select / TreeSelect / Cascader / AutoComplete 设计通用的 `OptionKey` / `OptionValue` / `OptionNode` 抽象；
   - 与现有 Form 的 `serde_json::Value` 模型兼容，避免多套值模型并存。

2. **下拉浮层基础设施复用 OverlayManager**
   - 所有下拉类组件复用 OverlayManager 管理 z-index 和挂载容器；
   - 与 App / ConfigProvider 一致地尊重全局 `size` / `disabled` / 主题 token。

3. **Form 受控用法优先**
   - 在 Form 场景下，优先保证受控行为（值由 FormStore 管理）正确、可预期；
   - 独立使用时保留受控/非受控两种模式，并尽量贴近 Dioxus/Rust 的直觉。

4. **逐步扩展能力**
   - 每个组件先实现最常用的子集（单选、多选、基础搜索），再按需扩展；
   - 明确在文档中标记已支持/未支持的 AntD 行为，避免使用方误解。

---

## 三、任务拆解与 TODO

### A. 能力范围梳理与 API 草案

- [x] A1：调研 `tmp/antd-6.0.0/es` 下以下目录源码与类型声明：
  - `select` / `tree-select` / `cascader` / `auto-complete`；
  - 提取核心概念：option/value 模型、受控 props、事件（onChange/onSelect/onSearch）、搜索与过滤行为、键盘交互、标签渲染等。
- [x] A2：结合当前 Form / OverlayManager / ConfigProvider 能力，确定本轮 **MVP 范围**，明确：
  - Select：单选、多选、多标签，基础搜索，Form 集成；
  - TreeSelect：单选、多选（勾选树节点），仅支持简单非异步树数据；
  - Cascader：多级级联（点击展开子级），基本值路径映射；
  - AutoComplete：基于 Input 的建议列表，与 Select 共用部分逻辑；
  - 暂不支持的特性（如虚拟滚动、复杂 `labelInValue` 组合、远程搜索、`mode=tags` 的所有细节等）。
- [x] A3：在本文件或 `docs/app_config.md` 补充一小节「选择器家族（规划）」：
  - 描述四个组件之间的关系；
  - 标明本轮实现的子集和后续可扩展能力。

### B. 选项模型与通用下拉基础设施

> 目标：先抽象出统一的 option/value 建模和 dropdown 容器，避免每个组件各自造轮子。

- [x] B1：设计统一的选项类型与 key/value 抽象，初步方案：
  - `SelectOption`：`{ key: String, label: String, disabled: bool }`；
  - `TreeNode`：`{ key: String, label: String, disabled: bool, children: Vec<TreeNode> }`；
  - `CascaderNode`：可直接复用 `TreeNode` 或定义轻量别名；
  - 通过 `serde_json::Value` 或强类型结构与 Form 值做映射。
- [x] B2：在 `src/components` 下新增 `select_base.rs` 或类似模块，定义：
  - 通用的 option 列表渲染容器（负责滚动、空态、loading 等）；
  - 通用的键盘交互（上下箭头、Enter、Esc、Tab 等）和高亮管理；
  - 与 OverlayManager 集成的 dropdown 容器（控制打开/关闭、挂载位置、z-index）。
- [x] B3：实现共享工具函数：
  - option 列表扫描与匹配（根据 key/label 做搜索过滤）；
  - 多选选项的添加/删除逻辑；
  - 将 `serde_json::Value` 与内部 `OptionKey`/`Vec<OptionKey>` 互转的辅助函数（用于 Form 集成）。
- [x] B4：为 `select_base` 增加最小测试或 demo（内部用），验证：
  - 键盘导航与高亮行为；
  - OverlayManager 生成的 z-index 行为。

### C. Select：基础下拉选择

- [x] C1：设计 `SelectProps` 的 MVP 结构，参考 AntD 但适配 Rust：
  - `value: Option<String>` / `values: Option<Vec<String>>`（单选/多选）；
  - `options: Vec<SelectOption>`；
  - `multiple: bool` / `allow_clear: bool` / `placeholder` / `disabled` / `size`；
  - `on_change: Option<EventHandler<Vec<String>>>`（对于单选可约定 Vec 长度为 0 或 1）；
  - Form 集成的 name/value 通过 `FormItem`/`use_form_item_control` 处理。
- [x] C2：实现 `Select` 组件：
  - 受控/非受控两种模式；
  - 使用 `select_base` 的 dropdown 逻辑 + OverlayManager；
  - 尊重 ConfigProvider 的 `size`/`disabled`，同时本地 props 优先；
  - 在 Form 场景下：从 `FormItemControlContext` 读取/写入值，确保 UI 与 FormStore 一致。
- [x] C3：新增 `examples/select_demo.rs`，覆盖：
  - 单选 + 多选 + disabled；
  - 与 Form 的组合使用（必填校验、reset 行为）。
- [x] C4：在 `docs/select.md` 中记录 Select 的 API、受控/非受控与 Form 集成行为，以及与 AntD 的差异。

### D. TreeSelect：树形选择

- [x] D1：设计 `TreeSelectProps` 的 MVP 结构：
  - `tree_data: Option<Vec<TreeNode>>`（可选树数据源，节点包含 key/label/disabled/children）；
  - `value: Option<String>` / `values: Option<Vec<String>>`（单选/多选受控值）；
  - `multiple: bool` / `tree_checkable`（多选勾选模式开关）；
  - `show_search`（基于 label 的简单本地搜索）；
  - `placeholder` / `disabled` / `status` / `size` / 弹层类名与样式；
  - `on_change: Option<EventHandler<Vec<String>>>`；
  - Form 集成同 Select（后续在 D2 中通过 FormItemControlContext 接线）。
- [x] D2：实现 `TreeSelect` 组件：
  - 复用 `select_base` 的 dropdown 与键盘交互；
  - 在列表内渲染树形结构（缩进/展开/禁用）；
  - 多选模式下的勾选行为与值聚合逻辑（可先不实现半选状态）。
- [x] D3：新增 `examples/tree_select_demo.rs`，展示：
  - 基础树形单选/多选；
  - 与 Form 组合用于层级字段选择（例如部门/分类）。
- [x] D4：在新文档 `docs/select_family.md` 描述 TreeSelect 的能力范围与与 AntD 差异，并在 `docs/README.md` 中挂载索引。

### E. Cascader：级联选择

- [x] E1：设计 `CascaderProps` 的 MVP 结构：
  - `options: Vec<CascaderNode>`（可以重用 TreeNode 结构）;
  - `value: Option<Vec<String>>`（值路径，如 `["zhejiang", "hangzhou"]`）；
  - `on_change: Option<EventHandler<Vec<String>>>`；
  - `placeholder` / `allow_clear` / `multiple`（可以先不支持多选，多选字段作为 API 预留）。
- [x] E2：实现 `Cascader` 组件：
  - 复用 dropdown 容器，内部渲染多列结构；
  - 点击父节点展开子列，点击叶子节点触发 `on_change` 并关闭下拉；
  - 与 Form 集成时，使用 `Value::Array` 存储路径，并通过 `value_to_path` / `path_to_value` 互转。
- [x] E3：新增 `examples/cascader_demo.rs`，展示：
  - 典型地区选择场景；
  - 与 Form 集成的校验与 reset 行为。
- [x] E4：在 `docs/select_family.md` 中补充 Cascader 章节，说明当前不支持异步加载/虚拟滚动等高级能力，并与 AntD 差异对齐。

### F. AutoComplete：输入联想

- [x] F1：设计 `AutoCompleteProps`：
  - `value: Option<String>` / `default_value: Option<String>`；
  - `options: Option<Vec<SelectOption>>`；
  - `on_search: Option<EventHandler<String>>`（用户输入时回调）；
  - `on_select: Option<EventHandler<String>>`（选择某项时回调，参数为 key）；
  - 支持受控/非受控输入模式，沿用现有 `Input` 的行为（placeholder/allow_clear/status/size）。
- [x] F2：实现 `AutoComplete` 组件：
  - 在 UI 上复用 Input 风格，行为上复用 `select_base` 的 option 模型与 dropdown；
  - 默认在前端对 `options` 按 label 做简单过滤，`on_search` 用于外部更新数据源；
  - 与 Form 集成时，直接以字符串形式读写字段值。
- [x] F3：新增 `examples/auto_complete_demo.rs`，展示：
  - 静态 options 联想；
  - 通过 debug 信号展示 `on_change` / `on_search` / `on_select` 行为；
  - 与 Form 集成的校验与 reset 行为。
- [x] F4：在 `docs/select_family.md` 中补充 AutoComplete 的说明与对比关系。

### G. 集成验证与收尾

- [x] G1：构建一个综合示例（`examples/select_family_integration_demo.rs`），验证：
  - 在同一表单中组合使用 Select / TreeSelect / Cascader / AutoComplete；
  - 校验与 reset 行为与现有 Form 模型一致；
  - 全局 ConfigProvider/ThemeProvider 对 size/disabled 的控制是否被各组件正确继承。
- [x] G2：运行基础检查命令：
  - `cargo check --all-targets --all-features` 已通过；
  - `cargo check --examples` 已通过；
  - clippy 暂存在若干 `unused_mut`/`unused_imports` 级别告警，主要集中在 demo 与部分组件局部变量，后续可统一通过 `cargo fix` 清理。
- [x] G3：整理文档：
  - 在 `docs/README.md` 中增加「选择器家族」条目，指向 `docs/select_family.md`（已完成）；
  - 在 Form 文档中增加到选择器家族文档的说明（`docs/form.md` 顶部增加引用）；\n  - 在 `docs/select_family.md` 中补充 AutoComplete 小节及与 AntD 的差异说明。
