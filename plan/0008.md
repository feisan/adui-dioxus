# 任务计划：浮层提示与下拉菜单 Tooltip / Popover / Popconfirm / Dropdown（Phase 5）

## 一、背景与本轮目标

在前几轮（`plan/0001`–`0007`）中，已经完成：

- App / ConfigProvider / OverlayManager 以及 Message / Notification / Modal / Drawer 等全局浮层；
- 表单控件（Input / Checkbox / Radio / Switch / Upload 等）与选择器家族（Select / TreeSelect / Cascader / AutoComplete）；
- 统一的 OverlayKind::Dropdown 下拉基础设施（用于 Select/TreeSelect/Cascader 等）。

Ant Design 6.x 中，还有一组与浮层能力紧密结合、在实际业务中非常高频的组件：

- `Tooltip`：轻量级气泡提示，主要用于 hover 文案说明；
- `Popover`：内容更丰富的气泡卡片，可包含标题、内容、操作；
- `Popconfirm`：基于 Popover 封装的确认对话框，常用于“危险操作”的二次确认；
- `Dropdown`：菜单型下拉选择，常与 Menu/按钮搭配用于操作入口。

这些组件与现有 OverlayManager、Message/Modal/Notification 等存在明显复用关系，也是完善“浮层交互体系”的关键。本轮（Phase 5）目标：

- 设计并实现一个统一的「浮层触发与定位」基础层（trigger + placement + open/close）；
- 在该基础上实现 MVP 版本的 Tooltip / Popover / Popconfirm / Dropdown；
- 与现有 OverlayManager / ConfigProvider 深度集成，并通过 demo 与文档沉淀设计细节。

> 本轮同样采用 MVP 策略，优先实现常用子集（简单定位、hover/click 触发、基本内容展示），为之后扩展高级能力（复杂定位、嵌套菜单、多级触发）打基础。

---

## 二、设计原则

1. **统一的浮层触发模型**
   - 抽象 `trigger` 概念：`hover` / `click` / `focus` / `contextMenu`（MVP 先实现前两种）；
   - 抽象 `placement` 概念：参考 AntD 但裁剪为小集合（如 `top/bottom/left/right` + `*-start/end`）。

2. **OverlayManager 统一管理浮层实例**
   - 所有浮层类组件（Tooltip/Popover/Popconfirm/Dropdown）通过 OverlayManager 注册实例，避免 z-index/挂载点冲突；
   - 需要设计新的 `OverlayKind` 变种（如 `OverlayKind::Tooltip` / `OverlayKind::Popup` / `OverlayKind::DropdownMenu`），或基于统一 kind + meta 区分。

3. **与现有组件协同**
   - Button / Icon / Menu / Select 等均可作为触发器使用，但本轮先围绕 Button/Icon 进行验证；
   - 避免在 Tooltip/Popover 里重复发明状态管理，优先复用现有 click-outside/Esc 关闭机制。

4. **易用 API 与合理裁剪**
   - 以 AntD API 为参考，但结合 Rust/Dioxus 特性精简字段：
     - 例如去掉一部分复杂的 `builtinPlacements`、不支持 `mouseEnterDelay`/`mouseLeaveDelay` 的精细控制；
     - 先支持同步回调和简单受控模式（`open` + `onOpenChange`）。

---

## 三、任务拆解与 TODO

### A. 能力范围梳理与基础设计

- [x] A1：调研 `tmp/antd-6.0.0/es` 下以下目录源码与类型声明：
  - `tooltip` / `popover` / `popconfirm` / `dropdown`；
  - 关注点：
    - trigger 行为（hover / click / focus / contextMenu）；
    - placement 系统与对齐方式；
    - 浮层内容结构（title/content/icon/ok/cancel 文案等）；
    - 受控/open 模式与 `onOpenChange` 事件；
    - Dropdown 与 Menu 的耦合关系。
- [x] A2：结合当前 OverlayManager 与 Select 家族实现，确定本轮 **MVP 范围**：
  - Tooltip：支持 `title`、`placement`、`mouseEnter`/`mouseLeave` 打开关闭；
  - Popover：在 Tooltip 基础上增加 `title`/`content` slot 与 click 触发；
  - Popconfirm：在 Popover 基础上增加 ok/cancel 按钮和 `onConfirm`/`onCancel` 回调；
  - Dropdown：支持 Button 触发 + 菜单列表，点击菜单项关闭并触发回调；
  - 暂不实现的特性：复杂对齐、内嵌滚动容器定位、`getPopupContainer` 深度自定义等。
- [x] A3：在 `docs/app_config.md` 或 `docs/select_family.md` 中增加一段「浮层体系规划」，简述：
  - OverlayManager 负责所有浮层类型的注册；
  - Tooltip/Popover/Popconfirm/Dropdown 与 Modal/Drawer/Message/Notification 的关系与区别。

### B. Overlay 扩展与浮层基础设施

> 目标：在 OverlayManager 上抽象一层通用的「定位浮层」基础能力，以便 Tooltip/Popover/Dropdown 共用。

- [x] B1：在 `src/components/overlay.rs` 中扩展 OverlayKind 与元数据设计：
  - 新增适合本轮的 kind（如 `Tooltip` / `Popup` / `DropdownMenu`）或保留一个通用 kind + `meta.role` 区分；
  - 补充浮层元信息结构（如 `placement`、`target_rect`、`offset`），为未来复杂定位留扩展点。（当前阶段先扩展 kind，元信息按需迭代。）
- [x] B2：设计一个通用的 `use_floating_layer` Hook：
  - 类似 `use_dropdown_layer(open: bool)` 的接口，返回：
    - `z_index: Signal<i32>`
    - 可能的 `overlay_key` 与浮层 meta；
  - 在 hook 内部根据 `open` 状态自动 open/close overlay 实例，目前在 `select_base.rs` 中实现，并保留 `use_dropdown_layer` 作为下拉类组件专用包装。
- [x] B3：抽象“点击空白关闭 + Esc 关闭”通用逻辑：
  - 参考 Select 家族的 `internal_click_flag` + document click 方案，在 `src/components/floating.rs` 中整理成 `use_floating_close_handle(open)` helper；
  - 后续 Tooltip/Popover/Popconfirm/Dropdown 统一通过 `mark_internal_click` + ESC 处理组合使用，避免多个浮层叠加时互相误伤。

### C. Tooltip：轻量提示

- [x] C1：设计 `TooltipProps` MVP 结构：
  - `title: Option<String>` 或 `content: Option<Element>`（MVP 先用 `Element` slot + 简单 `String` 辅助）；
  - `placement: Option<TooltipPlacement>`（枚举，先支持 `Top/Bottom/Left/Right` + 简单偏移）；
  - `trigger: TooltipTrigger`（`Hover`/`Click`，MVP 可默认 Hover）；
  - `open: Option<bool>` / `default_open: Option<bool>` + `on_open_change: Option<EventHandler<bool>>`；
  - `disabled: bool` / `class` / `style`。
- [x] C2：实现 `Tooltip` 组件：
  - 使用 `use_floating_layer(OverlayKind::Tooltip, open)` 与 OverlayManager 获取 z-index 并挂载浮层；
  - 处理 hover 触发（mouseenter/mouseleave）与 click 触发逻辑；
  - 结合 `use_floating_close_handle` 处理点击空白与 ESC 关闭；
  - 浮层内容为简单的气泡框，带基础样式（参考 AntD，但先用简化版 CSS）。
- [x] C3：新增 `examples/tooltip_demo.rs`，展示：
  - Button + Icon 上挂载 Tooltip 的常见用法；
  - `placement` 变体；
  - 受控 `open` 模式的简单示例。
- [x] C4：在新文档（可选择 `docs/tooltip_popover.md`）中记录 Tooltip 的 API 与行为。

### D. Popover：富内容气泡卡片

- [x] D1：在同一文档中设计 `PopoverProps`（可与 Tooltip 共享部分字段）：
  - `title: Option<Element>` / `content: Option<Element>`；
  - `placement` / `trigger` / `open` / `on_open_change` 与 Tooltip 保持一致；
  - 额外的 `overlay_class_name` / `overlay_style` 等。
- [x] D2：实现 `Popover` 组件：
  - 基于 Tooltip 的浮层基础设施，内部渲染结构更丰富（标题 + 内容）；
  - 默认触发为 `Click`，点击触发区切换 open 状态；
  - 支持 click-outside 和 Esc 关闭（复用 `use_floating_close_handle`）。
- [x] D3：新增 `examples/popover_demo.rs`，展示：
  - Button 上弹出 Popover 的基础用法；
  - 不同 `placement`，以及内嵌按钮/链接等内容。
- [x] D4：在文档中补充 Popover 小节，说明与 Tooltip 的差异与复用关系。

### E. Popconfirm：确认气泡

- [x] E1：基于 Popover API 设计 `PopconfirmProps`：
  - `title: String` / `description: Option<String>`；
  - `ok_text` / `cancel_text`；
  - `on_confirm: Option<EventHandler<()>>` / `on_cancel: Option<EventHandler<()>>`；
  - `ok_type` / `ok_button_props` 简化为 ButtonType/危险态即可，暂不支持完整 ButtonProps 透传。
- [x] E2：实现 `Popconfirm` 组件：
  - 内部复用 Popover 的浮层结构与打开/关闭逻辑；
  - 提供两个按钮：Confirm/Cancel，点击后调用回调并关闭；
  - 支持受控 `open` + `on_open_change`，满足复杂业务需求。
- [x] E3：新增 `examples/popconfirm_demo.rs`，展示：
  - 危险操作按钮（删除/停用）挂载 Popconfirm 的典型场景；
  - `on_confirm` 中触发 Message/Notification 的示例（演示与现有反馈组件的协同）。
- [x] E4：在文档中补充 Popconfirm 小节，说明它是如何在 Popover 上进行二次封装的。

### F. Dropdown：菜单型下拉

> 这里的 Dropdown 指“触发菜单”的 Button/Link，内部挂载菜单项；完整 Menu 组件可在后续独立计划中扩展。

- [x] F1：设计 `DropdownProps` MVP：
  - `overlay: Element` 或简化后的菜单描述（MVP 可先支持 `Vec<MenuItem>` 的轻量结构）；
  - `trigger: DropdownTrigger`（`Click`/`Hover`，MVP 先支持 Click）；
  - `placement: DropdownPlacement`（同 Tooltip/Popover，大致方向一致）；
  - `open: Option<bool>` / `on_open_change`；
  - `disabled: bool` / `class` / `overlay_class` / `overlay_style`。
- [x] F2：实现 `Dropdown` 组件：
  - 使用 `use_floating_layer(OverlayKind::Dropdown, open)` 在触发元素下方对齐展示菜单；
  - 点击菜单项时关闭下拉并触发 `on_click` 回调（若使用轻量 `MenuItem` 模型）；
  - 支持 click-outside 和 Esc 关闭（复用 `use_floating_close_handle`）。
- [x] F3：新增 `examples/dropdown_demo.rs`，展示：
  - Button + Dropdown 菜单基本用法；
  - 带 Icon 的菜单项；
  - 与 App/ConfigProvider 的 size/disabled 继承行为。
- [x] F4：在文档中补充 Dropdown 小节，说明当前仅支持轻量菜单模型，完整 Menu 交互在后续计划中实现。

### G. 集成验证与收尾

- [x] G1：构建一个综合示例（如 `examples/overlay_family_demo.rs`），验证：
  - Tooltip / Popover / Popconfirm / Dropdown 在同一页面的叠加行为；
  - 与 Modal/Drawer/Message/Notification 的共存与 z-index 关系；
  - click-outside 与 Esc 关闭在多层嵌套时仍然工作正常。
- [x] G2：全量运行 `cargo fmt` / `cargo clippy --all-targets --all-features` / `cargo test`，并记录：
  - 新增模块的 clippy 建议（当前存在若干 `unused_mut` / `clone_on_copy` 等警告，后续计划集中清理，不影响功能验证）；
  - 组件核心逻辑通过现有单元测试覆盖（`cargo test` 通过，部分 Form 相关测试按设计标记为 `ignored`）。
- [x] G3：整理文档：
  - 在 `docs/README.md` 中增加「浮层组件」条目，指向新的 Tooltip/Popover/Popconfirm/Dropdown 文档（已完成）；  
  - 在 Button / App / ConfigProvider / Form 文档中补充与 Overlay 相关的说明与示例链接；  
  - 在 `docs/tooltip_popover.md` 中对比 AntD 6.0，明确当前实现与未实现的能力（延时、复杂定位、多级 Dropdown 等），作为后续扩展参考。
