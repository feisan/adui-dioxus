# 任务计划：Form 高级能力（Phase 2）

## 一、背景与本轮目标

上一轮（`plan/0004.md`）已经完成：

- FormStore 作为单一数据源的重构；
- Input/TextArea + Checkbox/Radio/Switch 在 Form 场景下的受控模式统一；
- `validate_all` 的提交策略与 Ant Design 行为基本对齐；
- 文档同步更新。

当前仍缺失的典型 Form 高级能力包括：

- 动态字段列表（类似 AntD 的 `Form.List`）；
- 字段依赖与联动（`dependencies` / `on_values_change`）；
- 更灵活的值映射（`value_prop_name` / `getValueFromEvent`）；
- 更细粒度的校验触发（`validateTrigger`）。

本轮（Phase 2）聚焦在 **三个最常用且彼此协同的能力**：

1. 动态字段列表：`FormList`（支持数组字段增删项）。
2. 字段联动与变更通知：`on_values_change` + 简化版 `dependencies`。
3. 自定义值映射：在 `FormItem` 层增加 `value_prop_name` / `get_value_from_event` 的 Rust 风格实现，降低自定义控件接入成本。

> 备注：`validateTrigger` 与异步校验暂不在本轮范围内，后续如有时间可单开 Phase 3 处理。

---

## 二、设计原则（延续上一轮）

1. **Form 仍是唯一真相源**：所有高级能力都围绕 FormStore 的读写展开，不引入额外全局状态。
2. **API 尽量贴近 AntD，但遵循 Rust/Dioxus 范式**：
   - 类型命名与语义向 AntD 靠拢，例如 `FormList`, `FormItemProps::dependencies`；
   - 签名、生命周期与事件处理使用 Rust/Dioxus 习惯写法（闭包、`EventHandler`、所有权清晰）。
3. **渐进增强**：优先实现最小可用 MVP，再根据实际使用反馈迭代；必要时在文档中标明“子集实现”。

---

## 三、任务拆解与 TODO

### A. 能力范围确认与 API 草案

- [x] A1：梳理 AntD 6.x 中与 Form 高级能力相关的 API（以 `Form.List` 源码与 AntD 文档为参考，结合对 `onValuesChange` / `valuePropName` / `getValueFromEvent` / `dependencies` 的既有认知），提炼核心行为。
- [x] A2：结合当前实现，确定本轮三项能力的 **MVP 范围** 与不做的部分，并在 `docs/form.md` 追加一个「高级能力范围」小节简要说明。
- [x] A3：给出初步 API 草案（放在本文件或 `docs/form.md` 中），包括：
  - [x] `FormList` 组件的 props 结构与子项渲染方式；
  - [x] `FormProps::on_values_change` 的签名；
  - [x] `FormItemProps` 上 `dependencies` / `value_prop_name` / `get_value_from_event` 的字段类型。

### B. FormList（动态字段列表）

> 目标：支持对数组字段（如 `emails: Vec<Email>`）进行增删项，并让其值映射成 `Value::Array`。先支持一维列表，不处理嵌套 List。

- [x] B1：内部数据模型设计（Value::Array 约定 + `form_list_*` 辅助函数）。
- [x] B2：`FormList` 组件 API 设计与类型定义（`FormListProps` / `FormListItemMeta` / `FormList` 占位实现）。
- [x] B3：`FormList` 具体实现（基于 `FormContext` 暴露 `FormListContext`，结合 `form_list_*` helper 操作 FormStore 并提供 `len/insert/remove` 能力）。
- [x] B4：示例与文档（`examples/form_list_demo.rs` + `docs/form.md` FormList 小节）。

### C. 字段联动与 on_values_change

- [x] C1：在 `FormProps` 中引入 `on_values_change`，并在 `FormItemControlContext::set_value` 路径触发（每次字段值变更后回调，携带 changed_values/all_values）。
- [x] C2：在 `FormItemProps` 中支持简化版 `dependencies`，通过额外注册 `ScopeId` 到对应字段监听列表，实现基于字段名的渲染级联动。
- [x] C3：补充联动示例 `examples/form_deps_demo.rs`（“使用主邮箱作为联系邮箱”）展示 on_values_change + dependencies 的组合用法。

### D. 自定义值映射（value_prop_name / get_value_from_event）

- [x] D1：在 `FormItemProps` 设计并实现 `value_prop_name` / `get_value_from_event` 的最小子集 API（`GetValueFromEventFn = fn(Value) -> Value` + `FormItemControlContext::apply_mapped_value`）。
- [x] D2：仅在“自定义控件 + 手动使用 `use_form_item_control`”场景使用该机制；现有内置 Input/Checkbox/Radio/Switch 逻辑保持不变。
- [x] D3：在 `docs/form.md` 的高级能力小节中补充说明当前实现是 AntD 行为的子集，推荐用法为在控件内部从事件构造 `Value` 后调用 `ctx.apply_mapped_value(raw_value)`。

### E. 回归与收尾

- [x] E1：为新增能力增加必要的单元测试（`form_list_*` helper 使用忽略测试 + validate_all 边界测试），其余复杂路径由集成示例覆盖。
- [x] E2：全量运行 `cargo fmt` / `cargo clippy --all-targets --all-features` / `cargo test`，当前仅保留若干 Clippy 建议（如 `collapsible_if`、`clone_on_copy`），不影响行为，后续可在重构时按需优化。
- [x] E3：在 `docs/form.md` 的「高级能力范围」中补充 FormList / on_values_change / dependencies / 自定义值映射的范围说明，`docs/README.md` 中继续将 `validateTrigger`、异步 validator 等列为“未覆盖能力”。
