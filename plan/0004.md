# 任务计划：Form 作为单一数据源的控件重构（已完成）

## 背景概览（简版）

- 目标：在 `FormItem` 场景下，以 `FormHandle` 内部的 FormStore 作为**唯一真相源**，所有控件（Input/TextArea/Checkbox/Radio/Switch 等）在 Form 中只负责受控渲染和写回，不再各自长期持有状态副本。
- 非 Form 场景继续支持标准受控/非受控模式（`value/checked` + `on_change`，或 `default_*` + 内部 `Signal`）。

详细设计要点已记录在 `docs/form.md` 的「设计要点（重要）」小节。

## 最终 TODO 列表

> 所有条目均已完成，这里保留的是精简后的结果清单，方便回顾。

- [x] **基础设施与 helper**
  - 在 `src/components/form.rs` 中集中实现 `form_value_to_string` / `form_value_to_bool` / `form_value_to_string_vec` / `form_value_to_radio_key` 等 Value 转换函数，并补充单元测试。
  - 明确定义 `value_is_empty` 规则，对 `Bool(false)` 视为“空”，方便在 Checkbox/Switch 上使用 `required`。

- [x] **Form 行为收敛**
  - `Form` 首次渲染时创建一次字段规则 registry，引入稳定的 `Rc<RefCell<HashMap<String, Vec<FormRule>>>>` 引用，`FormItem` 注册规则与 `validate_all` 使用同一份 registry。
  - `validate_all` 在 `values().is_empty()` 且存在任意 `required` 规则时，对所有必填字段执行校验并直接返回失败，保证“首次提交”和“reset 后立即提交”不会被误判为成功。
  - `reset_fields()` 只清空字段值与错误，不清理规则。

- [x] **Input / TextArea**
  - 在 Form 中：
    - 渲染值来自 `FormItemControlContext::value()` + `form_value_to_string`。
    - 事件通过 `ctx.set_string(next)` 写回 FormStore，内部 `Signal<String>` 不再更新。
  - 在 Form 外：保留原有受控/非受控逻辑。
  - `examples/form_demo.rs` 使用新模式，验证提交、重置、必填校验流程正确。

- [x] **Checkbox / CheckboxGroup**
  - 单 Checkbox 在 Form 中：
    - `checked` = `form_value_to_bool(ctx.value(), false)`。
    - 点击后通过 `ctx.set_value(Value::Bool(next))` 写回。
  - CheckboxGroup 在 Form 中：
    - 选中集合来自 `form_value_to_string_vec(ctx.value())`。
    - 勾选/取消后写回 `Value::Array([...])`。
  - 非 Form 模式继续使用 `default_checked` / `default_value` + 内部 `Signal` 或受控 `checked/value`。
  - `examples/input_checkbox_demo.rs` 中协议 Checkbox 的必勾选行为验证通过。

- [x] **Radio / RadioGroup**
  - RadioGroup 在 Form 中：
    - 初始选中值来自 `form_value_to_radio_key(ctx.value())`。
    - 点击子 Radio 时调用 `ctx.set_string(value)` 写回 FormStore，并通知 `on_change`。
    - 内部 `Signal<Option<String>>` 作为 Form 值的 UI 影子保持同步。
  - 单 Radio 在 Group 内按 Group 控制，独立使用时保持原有受控/非受控模式。

- [x] **Switch**
  - 在 Form 中：
    - 渲染 `checked` = `form_value_to_bool(ctx.value(), default_checked)`；若 Form 中无值，UI 初始状态由 `default_checked` 决定。
    - 点击/键盘操作仅基于当前 `checked` 取反，并调用 `ctx.set_value(Value::Bool(next))`；非受控模式下内部 `Signal<bool>` 只做 UI 过渡。
  - 在 Form 外：保留 `default_checked` + 受控 `checked` 行为。
  - `examples/input_checkbox_demo.rs` 中 `newsletter` 字段在提交与重置时行为正确。

- [x] **文档与索引**
  - `docs/form.md`：新增「设计要点（重要）」小节，记录：
    - FormStore/registry 的职责与生命周期；
    - `validate_all` 行为和空表单 + required 的逻辑；
    - 布尔字段的 `required` 语义。
  - `docs/input.md`：明确在 Form 场景下 Input/TextArea 完全忽略自身 `default_value`，以 FormStore 为唯一真相源。
  - `docs/checkbox_radio_switch.md`：说明 Checkbox/Radio/Switch 在 Form 中由 FormStore 控制，`default_checked` 只影响 UI 初始状态。
  - `docs/README.md`：在“未覆盖能力”中注明 Form 受控模式已基本对齐 AntD，后续表单控件扩展将围绕该模型展开。

- [x] **回归测试**
  - `cargo fmt` / `cargo clippy --all-targets --all-features` / `cargo test` 通过。
  - 手动验证：
    - `dx serve --example form_demo`：首次提交 / reset 后立即提交均正确触发必填校验；重置同步清空 UI 与内部值。
    - `dx serve --example input_checkbox_demo`：CheckboxGroup、协议 Checkbox、Switch、RadioGroup 在提交/重置/键盘交互下表现稳定。

> 若后续要引入 `FormItem` 的 `value_prop_name`、`getValueFromEvent` 以及 `Form.List`/动态字段等高级能力，可以在本文件基础上新建 `plan/0005.md` 进行拆分规划。
