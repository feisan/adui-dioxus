# 任务计划：日期时间选择 DatePicker / TimePicker / Calendar（Phase 10）

## 一、背景与本轮目标

前几轮计划（`plan/0001`–`0012`）已覆盖：

- 表单与输入：Input / TextArea / Checkbox / Radio / Switch / Upload + Form 高级能力；
- 选择器家族：Select / TreeSelect / Cascader / AutoComplete，与下拉浮层体系打通；
- 布局与导航：Layout / Grid / Flex / Space / Masonry / Splitter / Menu / Breadcrumb / Pagination；
- 浮层与全局反馈：App / ConfigProvider / OverlayManager / Tooltip / Popover / Popconfirm / Dropdown / Modal / Drawer / Message / Notification；
- 数据展示与状态：Typography / Divider / List / Table / Empty / Spin / Skeleton / FloatButton；
- 流程反馈：Alert / Result / Progress / Statistic / Steps 等。

对照 Ant Design 6.0，在「日期时间选择」这一块仍存在明显空缺：

- `DatePicker`：单日选择、区间选择（RangePicker），是中后台表单的刚需控件；
- `TimePicker`：时间点选择，常与 DatePicker 组合成日期时间选择器；
- `Calendar`：整月/全年视图的日期展示组件，常与 Badge / Tag / Tooltip 组合成日程视图。

本轮（Phase 10）目标：

- 设计并实现 DatePicker（含 RangePicker）、TimePicker、Calendar 的 MVP 版本；
- 与现有 Form / Layout / Card / Select / Tooltip / Popover 等组件协同，补齐日期时间相关场景；
- 形成一套可复用的日期时间内部模型（日期网格、格式化/解析、locale 文案），为后续扩展能力打基础。

> 仍采用 MVP 策略：优先覆盖大部分业务中「日期/时间选择 + 表单校验」的常见用法，暂不追求与 AntD 在所有变体（如 week picker、quarter picker、复杂面板切换动画等）上的完全对齐。

---

## 二、设计原则

1. **对齐 AntD 语义，裁剪罕见变体**
   - DatePicker：优先支持 `picker="date"` 的单选与 RangePicker 场景，MVP 暂不实现 week/month/quarter/year 等复杂变体；
   - TimePicker：先覆盖 24 小时制、时分秒选择与步进（minute_step/second_step），暂不实现复杂禁用区间与 12 小时 AM/PM 模式；
   - Calendar：优先实现月视图 + 年视图切换，支持基础交互（选择、切换月份/年份），暂不做完整自定义单元格渲染插槽体系。

2. **与 Form / ConfigProvider / Locale 深度集成**
   - Form：
     - 支持在 `FormItem` 中受控使用 DatePicker/TimePicker/RangePicker；
     - 统一 Form 值模型（例如使用字符串 ISO 格式或自定义 Value 枚举封装日期时间），避免每个组件各自为政；
     - 提供常用 `rules` 示例（如必填、开始时间必须早于结束时间、不能早于今天等）。
   - ConfigProvider / Locale：
     - 日期文案（星期、月份、"今天"、"此刻" 等）从统一 locale 配置中获取，至少预留英文/中文切换能力；
     - 与现有 `ComponentSize` 保持一致，小号/中号/大号输入高度与 Input 对齐。

3. **复用现有下拉浮层与 Overlay 能力**
   - DatePicker / TimePicker 的面板统一复用 Select / Cascader 等使用的下拉浮层机制：
     - `use_dropdown_layer` + OverlayManager 分配 z-index；
     - `use_floating_close_handle` 风格的 click-outside + ESC 关闭逻辑；
     - 触发区与面板内部交互前设置 internal_click_flag，避免误关闭。
   - Calendar 作为常驻视图组件，不依赖浮层，在 Layout/Card 中直接渲染。

4. **统一日期时间内部模型与工具函数**
   - 尽量抽象出可复用的内部工具：
     - 日期网格生成（给定年/月输出当月视图网格，含前后月占位）；
     - 简单的最小/最大日期比较与范围判定逻辑；
     - 文本格式化与解析（从内部结构到显示字符串，受 `format`/locale 影响）。
   - 优先选用稳定的 Rust 日期时间库（如 `time` 或 `chrono`），同时对外暴露统一的组件 API（例如使用字符串或轻量包装类型），减少使用方直接依赖第三方库的耦合。

5. **MVP 内聚，后续可渐进增强**
   - 先做出体验一致、API 清晰的 MVP，确保：
     - 表单集成顺畅，可通过 Form 统一校验与重置；
     - 浮层行为稳定（打开、关闭、键盘操作一致）；
     - 样式风格与现有 Input / Select 保持统一。
   - 未来再在新的 plan 中追加：week picker、日期时间一体选择、复杂 disabledDate 策略等能力。

---

## 三、任务拆解与 TODO

### A. 能力范围梳理与统一模型

- [x] A1：调研 `tmp/antd-6.0.0/es` 下以下目录源码与类型声明：
  - `date-picker` / `time-picker` / `calendar`；
  - 整理核心 Props 形态与常用组合方式（单选、区间、多视图切换、表单集成、受控 vs 非受控）。
- [x] A2：结合当前 Form/Select/Overlay 设计，确定本轮 **MVP API 范围**：
  - DatePicker：单选 + RangePicker，有限的 `disabled_date` / `format` 支持；
  - TimePicker：单时间点选择，包含基本步进与禁用选项能力；
  - Calendar：月/年模式切换，单日选中与基础回调；
  - 统一日期时间内部值模型与 Form 值序列化策略（例如内部使用 `time` 类型，对外传字符串或 Value 枚举）。
- [x] A3：在 `docs/app_config.md` 或新的补充文档中补充一小节「日期时间组件规划」，说明：
  - DatePicker / TimePicker / Calendar 的定位与关系；
  - 计划与 Form/ConfigProvider/Locale 的集成方式；
  - 后续可能扩展的高级能力（week picker、复杂禁用规则等）。

---

### B. DatePicker（含 RangePicker）

- [x] B1：设计 `DatePickerProps` 与内部值模型（`src/components/date_picker.rs`）：
  - 建议字段：
    - `value` / `default_value`：单个日期；
    - `on_change`：`EventHandler<Option<DateValue>>`（具体类型待 A2 定义）；
    - `placeholder` / `format`；
    - `disabled` / `allow_clear`；
    - `disabled_date`（MVP 版本可为简单函数：给定日期返回是否禁用，或先支持最小/最大日期属性）；
    - `class` / `style`；
  - RangePicker 可通过独立 Props 或复用结构（例如 `RangePickerProps` 中使用 `(Option<DateValue>, Option<DateValue>)`）。
- [x] B2：实现 DatePicker 组件：
  - 触发区域：
    - 基于 Input 风格的容器，显示当前格式化日期；
    - 支持清除按钮（allow_clear）与禁用态。
  - 下拉面板：
    - 使用统一日期网格生成逻辑；
    - 支持月份切换（前一月/后一月，当前实现默认从 2024-01 起步，后续可改为基于当前日期）；
    - 点击日期后更新值并触发 `on_change`，当前关闭行为仍交由外层控制，后续 B3/B4 可补充选择后自动关闭；
    - ESC 关闭 / 点击外部关闭 行为将在后续迭代统一接入浮层关闭工具，目前仅通过点击触发区显式控制 open 状态。
- [x] B3：实现 RangePicker：
  - 支持 `value` / `default_value` 为部分或完整区间（内部使用 `DateRangeValue { start, end }` 表示）；
  - 在面板中实现「开始-结束」双选逻辑：第一次点击设置 `start`，第二次点击设置 `end`，若第二次日期早于第一次则自动调换顺序；再次点击会从新的 `start` 重新选择；
  - 单月视图下对区间进行简单高亮：在 `start..=end` 范围内添加 `in-range` 类，并对起止两端添加 `range-start` / `range-end` 类；跨月场景暂仅在当前月内高亮，后续可在扩展阶段增强多月联动与 hover 效果。
- [x] B4：集成主题与样式：在 `src/theme.rs` 中新增 `.adui-date-picker-*` 样式：
  - 与 Input/Select 对齐的尺寸、边框、hover/focus 状态；
  - 日历面板头部（月份切换）、星期行、日期单元格的 hover/选中/禁用样式；
  - RangePicker 的区间高亮样式。
- [x] B5：新增 `examples/date_picker_demo.rs`：
  - 基础单选、受控/非受控示例；
  - RangePicker 示例（含简单禁用规则，如不能选择过去日期）；
  - 与 Form 结合的示例（校验必填、开始时间不得晚于结束时间）。
- [x] B6：文档：新增 `docs/date_picker.md`：
  - 说明 DatePicker/RangePicker API 与值格式；
  - 展示与 Form/ConfigProvider/Locale 集成方式及常见业务场景；
  - 明确当前未覆盖的 AntD 能力（week picker 等），以规避误用。

---

### C. TimePicker

- [x] C1：设计 `TimePickerProps`（`src/components/time_picker.rs`）：
  - 建议字段：
    - `value` / `default_value`：时间点；
    - `on_change`：`EventHandler<Option<TimeValue>>`；
    - `format`：默认 `HH:mm:ss`，MVP 可支持有限格式组合；
    - `hour_step` / `minute_step` / `second_step`；
    - `disabled` / `allow_clear`；
    - 简化的 `disabled_hours` / `disabled_minutes` / `disabled_seconds`（可选）；
    - `class` / `style`。
- [x] C2：实现 TimePicker 组件：
  - 触发区域与 DatePicker 对齐（输入框样式、清除按钮、禁用态）；
  - 下拉面板为多列滚动选择（时/分/秒），支持：
    - 步进过滤（按 step 渲染选项）；
    - 当前值高亮；
    - 点击选项更新 value 并关闭面板。
- [x] C3：样式集成：在 `src/theme.rs` 中新增 `.adui-time-picker-*` 样式：
  - 面板高度与列宽、滚动条样式；
  - 选中、高亮、禁用状态；
  - 与 DatePicker 面板在视觉上保持家族一致性。
- [x] C4：新增 `examples/time_picker_demo.rs`：
  - 基础 TimePicker 示例（含步进/禁用某些时间段）；
  - 与 DatePicker 组合成「日期 + 时间」表单项；
  - 演示 Form 校验与重置行为。
- [x] C5：文档：新增 `docs/time_picker.md`：
  - 说明 TimePicker API、格式化/解析策略；
  - 展示与 DatePicker/Calendar、Form 的组合示例；
  - 标注未覆盖的高级能力（如极复杂禁用规则、12 小时制等）。

---

### D. Calendar

- [x] D1：设计 `CalendarProps`（`src/components/calendar.rs`）：
  - 建议字段：
    - `value` / `default_value`：当前视图/选中日期；
    - `on_select`：选中日期回调；
    - `mode`：`Month` / `Year`；
    - `on_panel_change`：月份/年份/模式变化回调；
    - `fullscreen`：是否铺满容器（MVP 可作为样式上的布尔开关）；
    - （可选）简单 `date_cell_extra`：例如以 Element 形式插入额外内容；
    - `class` / `style`。
- [x] D2：实现 Calendar 组件：
  - 头部：
    - 月/年切换按钮；
    - 上一月/下一月、上一年/下一年控制；
  - 内容区：
    - 使用统一日期网格生成逻辑渲染当前视图；
    - 支持点击选中日期，触发 `on_select`；
    - 依据 `mode` 切换月视图或年视图（简化实现）。
- [x] D3：样式集成：在 `src/theme.rs` 中新增 `.adui-calendar-*` 样式：
  - 头部布局、导航按钮与当前月份/年份展示；
  - 单元格 hover/选中/今天高亮样式；
  - 与 Card 组合时的边距与背景处理。
- [x] D4：新增 `examples/calendar_demo.rs`：
  - 基础月历/年历展示；
  - 与 Badge / Tag / Tooltip 搭配，展示简单日程标记；
  - 与 Layout/Card 组合为「日程视图」示例。
- [x] D5：文档：新增 `docs/calendar.md`：
  - 说明 Calendar API 与模式；
  - 展示与 Card/Layout/Badge/Tag 等组件的组合方式；
  - 标注当前不支持的高度自定义单元格渲染能力。

---

### E. 集成验证与收尾

- [x] E1：在组件导出与主题中接入：
  - 更新 `src/components/mod.rs` 与 `src/lib.rs`，导出 DatePicker / TimePicker / Calendar 及相关 Props/枚举；
  - 在 `src/theme.rs` 中将新增样式纳入 `THEME_BASE_STYLE`，确保 ConfigProvider/ThemeProvider 一致加载。
- [x] E2：Form 与文档联动：
  - 已在 `docs/form.md` 中补充「日期时间组件与 Form 集成」小节，并在 `examples/date_picker_demo.rs` / `examples/time_picker_demo.rs` 中展示 DatePicker/RangePicker/TimePicker 的表单用法。
  - 已在 `docs/select_family.md` 中增加与日期时间选择组件的边界说明与组合建议。
- [x] E3：ConfigProvider / Locale 对接：
  - 在 `src/components/config_provider.rs` 中新增 `Locale` 枚举（`ZhCN` / `EnUS`）及 `ConfigProviderProps.locale`，并通过 `use_config()` 暴露到组件；
  - DatePicker / RangePicker / TimePicker / Calendar 已根据 `Locale` 切换占位文案与星期、月份标题；`docs/app_config.md` 也同步更新了相关说明。
- [x] E4：全量 fmt / clippy / test：
  - 已执行 `cargo fmt`、`cargo clippy --all-targets --all-features` 与 `cargo test --all-targets --all-features`，当前代码库在开启全部目标和特性的情况下可以正常编译并通过测试（仅保留已有的若干非阻断级别 clippy 警告）。
  - 本计划对应的新增组件与限制已在 `docs/date_picker.md` / `docs/time_picker.md` / `docs/calendar.md` 和本文件中记录。
